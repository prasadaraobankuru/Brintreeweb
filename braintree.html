<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Braintree PayPal PopupBridge</title>

  <!-- Braintree + PayPal SDKs -->
  <script src="https://js.braintreegateway.com/web/3.129.0/js/client.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.129.0/js/paypal-checkout.min.js"></script>
  <script src="https://www.paypalobjects.com/api/checkout.js"></script>
</head>
<body>
  <h3>Connecting to PayPal...</h3>

  <script>
    // ✅ Static config
    const clientToken = "sandbox_38zsjnr9_ydwkdrfr4jvvhf98"; // Replace with your own
    const paymentAmount = "10.00";
    const paymentCurrency = "USD";

    // ✅ Initialize Braintree Client
    braintree.client.create({ authorization: clientToken }, function (clientErr, clientInstance) {
      if (clientErr) {
        alert("Error creating Braintree client: " + clientErr);
        return;
      }

      // ✅ Create PayPal Checkout instance
      braintree.paypalCheckout.create({ client: clientInstance }, function (paypalErr, paypalCheckoutInstance) {
        if (paypalErr) {
          alert("Error creating PayPal checkout: " + paypalErr);
          return;
        }

        // ✅ Automatically start PayPal checkout
        paypalCheckoutInstance.createPayment({
          flow: "checkout",
          amount: paymentAmount,
          currency: paymentCurrency
        }, function (err, paymentID) {
          if (err) {
            alert("Error creating payment: " + err);
            return;
          }

          // ✅ Open PayPal in Custom Tab via PopupBridge
          if (window.popupBridge) {
            const paypalUrl = `https://www.sandbox.paypal.com/checkoutnow?token=${paymentID}`;
            window.popupBridge.open(paypalUrl);
          } else {
            // Fallback (in browser test mode)
            window.location.href = `https://www.sandbox.paypal.com/checkoutnow?token=${paymentID}`;
          }
        });
      });
    });

    // ✅ Handle PopupBridge result (after PayPal flow completes)
    if (window.popupBridge) {
      window.popupBridge.onComplete = function (err, payload) {
        if (err) {
          alert("PopupBridge error: " + err.message);
          return;
        }
        alert("Payment Success! Nonce: " + payload.nonce);
      };
    }
  </script>
</body>
</html>

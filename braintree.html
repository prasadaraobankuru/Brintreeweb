<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Braintree Payment UI</title>

  <script src="https://js.braintreegateway.com/web/3.129.0/js/client.min.js"></script>
  <script src="https://js.braintreegateway.com/web/3.129.0/js/hosted-fields.min.js"></script>
  <!-- Load the PayPal component. -->
  <script src="https://js.braintreegateway.com/web/3.129.0/js/paypal-checkout.min.js"></script>

  <style>
    @font-face {
      font-family: 'MyAldi';
      src: url('data:font/ttf;base64,{{BASE64_FONT}}') format('truetype');
      /* ðŸ‘ˆ Placeholder */
      font-weight: normal;
      font-style: normal;
    }

    html,
    body {
      font-family: 'MyAldi';

      font-weight: 400;
      overflow: hidden !important;
      overscroll-behavior: contain;
    }

    /* Allow PayPal modal scroll internally */
    .paypal-checkout-sandbox iframe,
    iframe[src*="paypal.com"] {
      position: fixed !important;
      overflow: auto !important;
      max-height: 100vh !important;
      touch-action: pan-y !important;
    }

    /* Prevent body from scrolling when modal is open */
    body.paypal-modal-open {
      position: fixed !important;
      width: 100%;
      overflow: hidden !important;
    }

    body {
      font-weight: 400;
      font-family: 'MyAldi';

      margin: 0;
      background: #fff;
      overflow-y: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    input {
      font-family: 'MyAldi';
      color: #D70000;
    }

    body::-webkit-scrollbar {
      display: none;
    }

    .checkout-container {
      max-width: 480px;
      margin: auto;
      background: #ffc800;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h3 {
      margin-bottom: 15px;
    }

    .option {
      display: flex;
      flex-direction: column;
      align-items: center;
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 0.25rem 1.125rem 0 rgba(75, 70, 92, 0.1);
    }

    .option-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-left img {
      width: 28px;
      height: 28px;
    }

    .option input[type="radio"] {
      accent-color: #00539b;
      width: 20px;
      height: 20px;
    }

    .expand-section {
      max-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: max-height 0.3s ease;
      gap: 12px;
      width: 100%;
    }

    .expand-section.active {
      margin: 10px 0;
      max-height: 100% !important;
    }

    .field {
      width: 100%;
    }

    label {
      font-size: 14px;
      font-weight: 400;
      font-family: 'MyAldi';

      margin-bottom: 6px;
      display: block;
      color: #656565;
    }

    label.required::after {
      content: " *";
      color: #D70000;
      font-weight: normal;
    }

    .card-header-text {
      font-weight: 900 !important;
      color: #002e6d;
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-logos {
      display: flex;
      flex-direction: row;
      gap: 4px;
      margin-left: 8px;
      position: absolute;
      right: 8px;
      top: 9px;
    }

    .card-logos img {
      height: 22px;
    }

    .lable1 {
      font-size: 14px;
      margin-bottom: 6px;
      display: block;
      color: #656565;
    }

    .hosted-field {
      position: relative;
      height: 28px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px 8px;
      background: #fff;
      font-size: 14px;
    }

    .hosted-field.valid {
      border-color: #00539b !important;
    }

    .hosted-field.invalid {
      border-color: red !important;
    }

    .hosted-field.focused {
      border-color: #00539b !important;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row .field {
      flex: 1;
    }

    #submit-button {
      display: none;
    }

    .consent {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 16px;
    }

    .consent span {
      font-size: 14px;
      color: #656565;
    }

    .error {
      color: red;
      font-size: 12px;
      margin-top: 8px !important;
      margin: 0px;
      display: none;
    }

    .note {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      background: #f4f6fa;
      font-size: 12px;
      line-height: 1.4;
      color: #3e3e3e;
    }

    .note strong {
      color: #002e6d;
    }

    #paypal-container .paypal-button {
      display: flex;
      justify-content: center;
    }

    .option:has(.expand-section.active) {
      border: 1px solid #00539b;
    }

    .card-header-section {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    input[type="checkbox"]:checked {
      accent-color: #002e6d;
    }

    .paypal-main-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #EDF7FF;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      color: #333;

      .check-box-container {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background-color: #00539B;
        position: relative;
        flex-shrink: 0;

        .check-icon {
          position: absolute;
          font-size: .75rem;
          color: #fff;
        }
      }

      .paypal-text {
        font-weight: normal;
        color: #3E3E3E;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 1rem;
        line-height: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div style="padding: 8px">
    <!-- Card option -->
    <div class="option">
      <div class="card-header-section" onclick="selectOption('card')">
        <div class="option-left">
          <img id="card-logo" />
          <span class="card-header-text">Card</span>
        </div>
        <input type="radio" name="payment" id="radio-card" />
      </div>

      <div id="card-section" class="expand-section">
        <div class="field">
          <label class="required">Card holder name</label>
          <div id="cardholder-name" class="hosted-field"></div>
          <p id="error-cardholder" class="error">
            Cardholder name is required
          </p>
        </div>

        <div class="field">
          <label class="required">Card number</label>
          <div id="card-number" class="hosted-field">
            <div class="card-logos">
              <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" />
              <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard" />
            </div>
          </div>
          <p id="error-number" class="error">Card number is invalid</p>
        </div>

        <div class="row">
          <div class="field">
            <label class="required">CVV</label>
            <div id="cvv" class="hosted-field"></div>
            <p id="error-cvv" class="error">CVV is invalid</p>
          </div>
          <div class="field">
            <label class="required">Expiration date</label>
            <div id="expiration-date" class="hosted-field"></div>
            <p id="error-expiration" class="error">
              Expiration date is invalid
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- PayPal option -->
    <div class="option">
      <div class="card-header-section" onclick="selectOption('paypal')">
        <div class="option-left">
          <img src="https://www.paypalobjects.com/webstatic/icon/pp258.png" />
          <span class="card-header-text">PayPal</span>
        </div>
        <input type="radio" name="payment" id="radio-paypal" />
      </div>

      <div id="paypal-section" class="expand-section">
        <p class="lable1">To use PayPal, click the button below :</p>

        <div id="paypal-button-container" style="text-align: center; position: relative;">
          <!-- PayPal button -->
          <div id="paypal-button"></div>

          <!-- ðŸ”¹ Loader (hidden by default) -->
          <div id="paypal-loader" style="
          display: none;
          margin-top: 10px;
          text-align: center;
          font-size: 14px;
          color: #002e6d;
          font-family: 'MyAldi';

        ">
            <div class="spinner" style="
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00539b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-family: 'MyAldi';
            animation: spin 1s linear infinite;
            margin: 8px auto;
          "></div>
            Loadingâ€¦
          </div>

          <!-- Powered by PayPal logo -->
          <!-- <div id="paypal-powered" style="margin-top: 8px">
            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/bdg_payments_by_pp_2line.png"
              alt="PayPal Powered" style="height: 20px" />
          </div> -->
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ Spinner animation -->
    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <!-- Global error -->
    <p id="error-method" class="error">Please select a payment method</p>
    <p id="error-paypal" class="error">
      Please complete PayPal authorization
    </p>
    <!-- consent -->
    <div class="consent">
      <input type="checkbox" id="consent" onchange="onConsentChange()" />
      <span>I consent to using my payment details for future transactions and
        identity validation</span>
    </div>
    <!-- <p id="consentError" class="error">Consent Required.</p> -->

    <script>
      let hostedFieldsInstance;
      let clientToken = null;
      let paymentAmount = 0;


      const errorIdMap = {
        number: "error-number",
        expirationDate: "error-expiration",
        cvv: "error-cvv",
        cardholderName: "error-cardholder",
      };

      function getErrorEl(emittedBy) {
        return document.getElementById(errorIdMap[emittedBy]);
      }

      // ðŸ”¹ Select payment option
      function selectOption(type) {
        const cardSection = document.getElementById("card-section");
        const paypalSection = document.getElementById("paypal-section");

        document.getElementById("radio-card").checked = type === "card";
        document.getElementById("radio-paypal").checked = type === "paypal";

        [cardSection, paypalSection].forEach((section) => {
          section.classList.remove("active");
          section.style.maxHeight = null;
        });

        const activeSection = type === "card" ? cardSection : paypalSection;
        activeSection.classList.add("active");
        activeSection.style.transition = "none";
        activeSection.style.maxHeight = "none";
        const fullHeight = activeSection.scrollHeight + "px";
        activeSection.style.maxHeight = "0px";

        requestAnimationFrame(() => {
          activeSection.style.transition = "max-height 0.3s ease";
          activeSection.style.maxHeight = fullHeight;
        });

        // ðŸ”¹ Notify Flutter
        if (window.flutter_inappwebview) {
          window.flutter_inappwebview.callHandler(
            "paymentMethodSelected",
            type
          );
        }

        // ðŸ”¹ Reset errors
        if (type === "card") {
          document.getElementById("error-paypal").style.display = "none";
        } else if (type === "paypal") {
          [
            "error-number",
            "error-expiration",
            "error-cvv",
            "error-cardholder",
          ].forEach(
            (id) => (document.getElementById(id).style.display = "none")
          );
          if (hostedFieldsInstance) {
            hostedFieldsInstance.clear("number");
            hostedFieldsInstance.clear("expirationDate");
            hostedFieldsInstance.clear("cvv");
            hostedFieldsInstance.clear("cardholderName");
          }
        }
      }

      //get amount from flutter 
      function setPaymentAmount(amount) {
        paymentAmount = parseFloat(amount);
        console.log("âœ… Payment amount received from Flutter:", paymentAmount);
      }

      // ðŸ”¹ Init Braintree
      function initBraintree() {
        if (!clientToken) {
          console.error("Client token not set!");
          return;
        }

        const setup = () => {
          braintree.client.create(
            { authorization: clientToken },
            (err, clientInstance) => {
              if (err) return console.error(err);

              // ðŸ”¹ Hosted Fields
              braintree.hostedFields.create(
                {
                  client: clientInstance,
                  styles: {

                    input: {
                      'font-size': '16px',
                      'color': '#333',
                      'font-family': 'MyAldi'

                    },
                    'input::placeholder': {
                      'color': '#999',
                      'font-family': 'MyAldi', // âœ… affects placeholder inside iframe
                      'font-size': '16px',
                    },

                  }, fields: {
                    number: {
                      selector: "#card-number",
                      placeholder: "Enter number",
                    },
                    expirationDate: {
                      selector: "#expiration-date",
                      placeholder: "MM/YY",
                    },
                    cvv: { selector: "#cvv", placeholder: "Enter" },
                    cardholderName: {
                      selector: "#cardholder-name",
                      placeholder: "Enter name ",
                    },
                  },
                },
                (err, hfInstance) => {
                  if (err) return console.error(err);
                  hostedFieldsInstance = hfInstance;

                  hfInstance.on("notEmpty", (event) => {
                    const errEl = getErrorEl(event.emittedBy);
                    if (errEl) errEl.style.display = "none";
                  });

                  hfInstance.on("input", (event) => {
                    const errEl = getErrorEl(event.emittedBy);
                    if (!errEl) return;
                    errEl.style.display = "none";
                  });

                  hfInstance.on("blur", (event) => {
                    const field = event.fields[event.emittedBy];
                    const errEl = getErrorEl(event.emittedBy);
                    if (!errEl) return;
                    errEl.style.display = field.isValid ? "none" : "block";
                  });

                  hfInstance.on("validityChange", (event) => {
                    if (event.fields[event.emittedBy].isValid) {
                      const errEl = getErrorEl(event.emittedBy);
                      if (errEl) errEl.style.display = "none";
                    }
                  });
                }
              );

              // ðŸ”¹ PayPal
              braintree.paypalCheckout.create(
                { client: clientInstance },
                (err, paypalCheckoutInstance) => {
                  if (err) return console.error("PayPal error:", err);

                  // load PayPal SDK with vault eligibility
                  paypalCheckoutInstance.loadPayPalSDK(
                    function () {
                      paypal
                        .Buttons({
                          fundingSource: paypal.FUNDING.PAYPAL,
                          style: { layout: "vertical", tagline: false },

                          createOrder: () => {
                            // ðŸ”¹ Show loader & hide button
                            document.getElementById("paypal-loader").style.display = "block";
                            document.getElementById("paypal-button").style.display = "none";
                            document.body.classList.add("paypal-modal-open");

                            // ðŸ”¹ Notify Flutter (user clicked PayPal)
                            if (window.flutter_inappwebview) {
                              window.flutter_inappwebview.callHandler("paymentMethodSelected", "paypal");
                            }

                            // ðŸ”¹ Start observing DOM for PayPal modal iframe is opening ot not checking case
                            const modalObserver = new MutationObserver(() => {
                              const modalIframe = document.querySelector('iframe[src*="paypal.com"]');
                              if (modalIframe) {
                                console.log("âœ… PayPal modal iframe detected, notifying Flutter...");

                                // ðŸ”¹ Notify Flutter BEFORE modal fully opens (so you can increase height)
                                if (window.flutter_inappwebview) {
                                  window.flutter_inappwebview.callHandler(
                                    "paymentMethodSelected",
                                    "paypal_modal_open"
                                  );
                                }

                                modalObserver.disconnect();
                              }
                            });

                            modalObserver.observe(document.body, {
                              childList: true,
                              subtree: true,
                            });

                            // ðŸ”¹ Continue with PayPal vault flow
                            return paypalCheckoutInstance.createPayment({
                              flow: 'checkout',
                              amount: paymentAmount,
                              currency: 'USD',
                              requestBillingAgreement: true,
                              billingAgreementDescription: "Save PayPal for future payments",
                            });
                          },

                          onApprove: (data) => {
                            document.body.classList.remove("paypal-modal-open");

                            // ðŸ”¹ Notify Flutter on modal close due to approval
                            if (window.flutter_inappwebview) {
                              window.flutter_inappwebview.callHandler(
                                "paymentMethodSelected",
                                "paypal_close"
                              );
                            }

                            return paypalCheckoutInstance.tokenizePayment(
                              data,
                              (err, payload) => {
                                if (err) return console.error(err);

                                // âœ… Nonce for vaulting
                                console.log("Nonce:", payload.nonce);

                                // âœ… PayPal email ID
                                console.log("PayPal Email:", payload.details.email);

                                // ðŸ”¹ Replace PayPal button with styled confirmation mail id
                                document.getElementById(
                                  "paypal-button-container"
                                ).innerHTML = `
                                      <div class="paypal-main-container">
                                      <span class="check-box-container">
                                        <span class="check-icon" style="color='#FFFFFF">&#10003;</span>
                                      </span>
 
                                  <span class="paypal-text">
                                 ${payload.details.email}
                                </span>
                               </div>
                              `;
                                window.paypalAuthorized = true;
                                document.getElementById("error-paypal").style.display = "none";

                                sendNonce(payload.nonce);
                              }
                            );
                          },

                          onCancel: () => {
                            document.getElementById("paypal-loader").style.display = "none";
                            document.getElementById("paypal-button").style.display = "block";
                            document.body.classList.remove("paypal-modal-open");

                            // ðŸ”¹ Notify Flutter on modal close due to cancel
                            if (window.flutter_inappwebview) {
                              window.flutter_inappwebview.callHandler(
                                "paymentMethodSelected",
                                "paypal_close"
                              );
                            }
                          },

                          onError: (err) => {
                            document.getElementById("paypal-loader").style.display = "none";
                            document.getElementById("paypal-button").style.display = "block";
                            document.body.classList.remove("paypal-modal-open");

                            console.error("PayPal error", err);
                            if (window.flutter_inappwebview) {
                              window.flutter_inappwebview.callHandler(
                                "paymentMethodSelected",
                                "paypal_close"
                              );
                            }
                          },
                        })
                        .render("#paypal-button");
                    }
                  );
                }
              );

            }
          );
        };

        if (hostedFieldsInstance) {
          hostedFieldsInstance.teardown(() => {
            hostedFieldsInstance = null;
            setup();
          });
        } else {
          setup();
        }
      }

      // ðŸ”¹ Called from Flutter
      function setClientToken(token) {
        clientToken = token;
        initBraintree();
      }


      // // ðŸ”¹ Consent
      // function validateConsent() {
      //   const checkbox = document.getElementById("consentCheckbox");
      //   const error = document.getElementById("consentError");
      //   if (checkbox.checked) {
      //     error.style.display = "none";
      //     return true;
      //   }
      //   error.style.display = "block";
      //   return false;
      // }
      function onConsentChange(type) {
        const checkbox = document.getElementById("consent")

        const isChecked = checkbox.checked;

        if (window.flutter_inappwebview) {
          window.flutter_inappwebview.callHandler("consentHandler", isChecked);
        }
      }
      // ðŸ”¹ Send nonce
   function sendNonce(nonce) {
  if (window.flutter_inappwebview) {
    window.flutter_inappwebview.callHandler("paymentHandler", nonce);
  } else if (window.AndroidBridge) {
    window.AndroidBridge.onPaymentNonce(nonce); // âœ… For native WebView
  }
}


      // ðŸ”¹ Tokenize Card
      function tokenizeCard() {
        if (!hostedFieldsInstance) return null;
        hostedFieldsInstance.tokenize((err, payload) => {
          if (!err && payload?.nonce) {
            sendNonce(payload.nonce);
          }
        });
      }

      // ðŸ”¹ Validate whole form
      function validateForm() {
        const cardSelected = document.getElementById("radio-card").checked;
        const paypalSelected = document.getElementById("radio-paypal").checked;
        let valid = true;

        document
          .querySelectorAll(".error")
          .forEach((e) => (e.style.display = "none"));

        if (!cardSelected && !paypalSelected) {
          document.getElementById("error-method").style.display = "block";
          return false;
        }

        if (cardSelected) {
          const state = hostedFieldsInstance?.getState();
          if (!state) return false;

          if (state.fields.cardholderName.isEmpty) {
            document.getElementById("error-cardholder").style.display = "block";
            valid = false;
          }
          if (!state.fields.number.isValid) {
            document.getElementById("error-number").style.display = "block";
            valid = false;
          }
          if (!state.fields.expirationDate.isValid) {
            document.getElementById("error-expiration").style.display = "block";
            valid = false;
          }
          if (!state.fields.cvv.isValid) {
            document.getElementById("error-cvv").style.display = "block";
            valid = false;
          }
        }

        if (paypalSelected && !window.paypalAuthorized) {
          document.getElementById("error-paypal").style.display = "block";
          valid = false;
        }

        return valid;
      }
    </script>
</body>

</html>
